<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>éŠ˜å³°è¼ªèƒ ä¿ƒéŠ·å¿«æŸ¥ | éŠ˜å³°è¼ªæ¥­</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root {
      --bg:#0b0f13;
      --card:#121821;
      --muted:#8aa1b1;
      --text:#e9f0f6;
      --accent:#ffd233;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:#0a0f13;
      color:var(--text);
      font-family:"Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    header{
      border-bottom:1px solid rgba(255,255,255,.06);
      background:#0c121a;
    }
    .wrap{
      max-width:980px;
      margin:auto;
      padding:16px 20px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand h1{
      font-size:22px;
      margin:0;
      font-weight:900;
    }
    .beta{
      background:var(--accent);
      color:#111;
      font-weight:700;
      padding:2px 8px;
      border-radius:8px;
      font-size:12px;
      margin-left:8px;
    }
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:16px;
      margin-top:16px;
    }
    .lbl{
      font-size:12px;
      color:#b9c7d4;
    }
    .input{
      width:100%;
      background:#0f151d;
      color:#fff;
      border:1px solid rgba(255,255,255,.1);
      border-radius:10px;
      padding:10px;
      margin-bottom:8px;
    }
    .filters{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:8px;
    }
    @media (min-width:680px){
      .filters{
        grid-template-columns:repeat(5,minmax(0,1fr));
      }
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    button{
      border:none;
      border-radius:10px;
      padding:10px 16px;
      font-weight:700;
      cursor:pointer;
    }
    .btn-yellow{
      background:var(--accent);
      color:#111;
    }
    .btn-gray{
      background:#1b2532;
      color:#e9f0f6;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
      font-size:14px;
    }
    th,td{
      padding:10px;
      border-top:1px solid rgba(255,255,255,.1);
    }
    th{
      color:#b9c7d4;
      text-align:left;
      background:#111722;
    }
    .price-sale{
      color:var(--accent);
      font-weight:800;
    }
    footer{
      margin:24px 0 16px;
      text-align:center;
      color:#8aa1b1;
      font-size:12px;
    }
    .status{
      font-size:12px;
      color:#b9c7d4;
      margin-top:6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <svg width="140" height="28" viewBox="0 0 140 28" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect width="140" height="28" rx="6" fill="#111722"/>
        <text x="12" y="19" font-family="Inter, Arial, 'Noto Sans TC'" font-weight="800" font-size="16" fill="#FFD233">éŠ˜å³°è¼ªæ¥­</text>
      </svg>
      <h1>è¼ªèƒä¿ƒéŠ·å¿«æŸ¥ <span class="beta">Beta</span></h1>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <label class="lbl">ç›´æ¥è¼¸å…¥å°ºå¯¸ï¼ˆæ”¯æ´ 205/55R16ã€205 55 16ã€205-55-16 ç­‰æ ¼å¼ï¼‰</label>
      <input id="sizeInput" class="input" placeholder="ä¾‹ï¼š205/55R16 æˆ– 205 55 16" />
      <div class="filters">
        <div class="field">
          <span class="lbl">èƒé¢å¯¬</span>
          <select id="selWidth" class="input"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div class="field">
          <span class="lbl">æ‰å¹³æ¯”</span>
          <select id="selAspect" class="input"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div class="field">
          <span class="lbl">è¼ªæ¡†å°ºå¯¸</span>
          <select id="selRim" class="input"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div class="field">
          <span class="lbl">å“ç‰Œ</span>
          <select id="selBrand" class="input"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div class="field">
          <span class="lbl">èŠ±ç´‹/å‹è™Ÿ</span>
          <select id="selPattern" class="input"><option value="">å…¨éƒ¨</option></select>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn-yellow" id="btnSearch">æŸ¥è©¢</button>
        <button class="btn-gray" id="btnReset">æ¸…é™¤</button>
      </div>
      <div class="status" id="statusText">è¼‰å…¥ä¸­â€¦</div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>å“ç‰Œ</th>
            <th>èŠ±ç´‹/å‹è™Ÿ</th>
            <th>å°ºå¯¸</th>
            <th>è¦æ ¼</th>
            <th>åŸåƒ¹</th>
            <th>ä¿ƒéŠ·åƒ¹</th>
            <th>å¹´ä»½</th>
            <th>æ•¸é‡</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>

    <footer>Â© éŠ˜å³°è¼ªæ¥­ ï½œ Demo ç‰ˆæœ¬ï¼Œå¯¦éš›ä¿ƒéŠ·ä»¥é–€å¸‚å…¬å‘Šç‚ºæº–ã€‚</footer>
  </main>

<script>
const SHEET_ID = "1HLZiY_X0LgQZ79q8YBtfTC6rT1DFX6lZC4gUVlGBuCs";
const GID      = "575923994"; // å¾Œå°_ä¿ƒéŠ·è³‡æ–™æ›´æ–°
const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

let promos = [];

const $ = (s) => document.querySelector(s);
function uniq(arr){ return [...new Set(arr.filter(v => v !== "" && v != null))]; }

// æŠ“å¯¬ / æ‰å¹³æ¯” / è¼ªæ¡†å°ºå¯¸
function parseSize(sizeRaw){
  if(!sizeRaw) return { width:"", aspect:"", rim:"" };
  const s = String(sizeRaw).toUpperCase().replace(/\s+/g,"");
  // ä¾‹ï¼š225/55R19ã€225/55ZR19ã€31X10.50R15LT ç­‰
  const m = s.match(/(\d{3})[\/\- ]?(\d{2})[A-Z]*R?(\d{2})/);
  if(m){
    return { width:m[1], aspect:m[2], rim:m[3] };
  }
  return { width:"", aspect:"", rim:"" };
}

// å°‡ä¸€åˆ—è³‡æ–™è½‰æˆç‰©ä»¶
function rowToPromo(rowObj){
  const brand   = rowObj["brand"] || "";
  const pattern = rowObj["pattern"] || "";
  const sizeRaw = rowObj["size"] || "";
  const specRaw = rowObj["spec"] || "";
  const origin  = rowObj["originPrice"] || "";
  const promo   = rowObj["promoPrice"] || "";
  const year    = rowObj["year"] || "";
  const qty     = rowObj["qty"] || "";

  const sz = parseSize(sizeRaw);

  return {
    brand,
    pattern,
    sizeRaw,
    specRaw,
    originPrice: origin,
    promoPrice: promo,
    year,
    qty,
    width: sz.width,
    aspect: sz.aspect,
    rim: sz.rim
  };
}

function money(n){
  if(n === undefined || n === null || n === "") return "";
  const num = Number(String(n).replace(/,/g,""));
  if(Number.isNaN(num)) return n;
  return "ï¼„" + num.toLocaleString("zh-Hant", { maximumFractionDigits: 0 });
}

function fillSelect(sel, arr){
  const el = $(sel);
  el.innerHTML = '<option value="">å…¨éƒ¨</option>';
  arr.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    el.appendChild(opt);
  });
}

function populateFilters(){
  const widths   = uniq(promos.map(p=>p.width)).sort((a,b)=>Number(a)-Number(b));
  const aspects  = uniq(promos.map(p=>p.aspect)).sort((a,b)=>Number(a)-Number(b));
  const rims     = uniq(promos.map(p=>p.rim)).sort((a,b)=>Number(a)-Number(b));
  const brands   = uniq(promos.map(p=>p.brand)).sort();
  const patterns = uniq(promos.map(p=>p.pattern)).sort();

  fillSelect("#selWidth", widths);
  fillSelect("#selAspect", aspects);
  fillSelect("#selRim", rims);
  fillSelect("#selBrand", brands);
  fillSelect("#selPattern", patterns);
}

function renderRows(rows){
  const body = $("#resultBody");
  body.innerHTML = "";
  if(!rows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = '<td colspan="8" style="color:#b9c7d4;">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>';
    body.appendChild(tr);
    return;
  }
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td>${r.brand || ""}</td>` +
      `<td>${r.pattern || ""}</td>` +
      `<td>${r.sizeRaw || ""}</td>` +
      `<td>${r.specRaw || ""}</td>` +
      `<td>${money(r.originPrice)}</td>` +
      `<td class="price-sale">${money(r.promoPrice)}</td>` +
      `<td>${r.year || ""}</td>` +
      `<td>${r.qty || ""}</td>`;
    body.appendChild(tr);
  });
}

// æŸ¥è©¢ï¼ˆå« 205/55R16ã€205-55-16ã€205 55 16 ç­‰ï¼‰
function search(){
  const w = $("#selWidth").value;
  const a = $("#selAspect").value;
  const r = $("#selRim").value;
  const b = $("#selBrand").value;
  const p = $("#selPattern").value;
  const s = $("#sizeInput").value.trim().toUpperCase();

  let rows = promos.slice();

  if(w) rows = rows.filter(x => String(x.width)  === w);
  if(a) rows = rows.filter(x => String(x.aspect) === a);
  if(r) rows = rows.filter(x => String(x.rim)    === r);
  if(b) rows = rows.filter(x => x.brand   === b);
  if(p) rows = rows.filter(x => x.pattern === p);

  if(s){
    const sNorm = s.replace(/[^0-9A-Z]/g, "").replace(/R/g,"");
    rows = rows.filter(x=>{
      const target = (x.sizeRaw || "").toUpperCase();
      const tNorm = target.replace(/[^0-9A-Z]/g, "").replace(/R/g,"");
      return tNorm.includes(sNorm);
    });
  }

  renderRows(rows);
}

function resetAll(){
  $("#sizeInput").value = "";
  ["#selWidth","#selAspect","#selRim","#selBrand","#selPattern"].forEach(sel=>{
    $(sel).value = "";
  });
  renderRows(promos);
}

// å¾ Google Sheet è¼‰å…¥è³‡æ–™ï¼ˆç”¨ cols ç•¶æ¬„ä½åç¨±ï¼‰
async function loadFromSheet(){
  const status = $("#statusText");
  try{
    status.textContent = "å¾å¾Œå°_ä¿ƒéŠ·è³‡æ–™æ›´æ–° è®€å–è³‡æ–™ä¸­â€¦";

    const res = await fetch(GVIZ_URL);
    const text = await res.text();

    // è§£æ gviz çš„ JSON
    const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const data = JSON.parse(jsonStr);

    // ğŸ‘‰ æ­£ç¢ºåšæ³•ï¼šæ¬„ä½åç¨±å¾ cols ä¾†
    const cols = (data.table.cols || []).map((c, idx) => {
      const label = (c.label || c.id || "").trim();
      return label || ("COL" + idx);
    });

    // rows å°±æ˜¯æ¯ä¸€ç­†è³‡æ–™
    const rows = data.table.rows || [];

    promos = rows.map(row => {
      const obj = {};
      (row.c || []).forEach((cell, idx) => {
        const key = cols[idx];         // é€™è£¡æœƒæ˜¯ brand / pattern / size / ...
        obj[key] = cell ? cell.v : "";
      });
      return rowToPromo(obj);          // äº¤çµ¦ rowToPromo å»æ‹†å¯¬åº¦/æ‰å¹³æ¯”ç­‰ç­‰
    });

    status.textContent = `å·²è¼‰å…¥ ${promos.length} ç­†è³‡æ–™ã€‚`;
    populateFilters();
    renderRows(promos);
  }catch(e){
    console.error(e);
    status.textContent = "è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚";
  }
}


document.addEventListener("DOMContentLoaded", ()=>{
  $("#btnSearch").addEventListener("click", search);
  $("#btnReset").addEventListener("click", resetAll);
  loadFromSheet();
});
</script>
</body>
</html>
